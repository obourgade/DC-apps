<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sourcing Academy - Development Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Logo Container -->
        <div id="logo-container" class="mb-4 flex justify-center items-center hidden">
            <img id="app-logo" src="" alt="Logo" class="max-h-24 max-w-full" />
        </div>
        
        <!-- App content will go here -->
        <h1 class="text-3xl font-bold text-center mb-6 text-primary">Sourcing Academy<br>Development Center<br>Lille July 2025</h1>
        
        <!-- Admin Panel Toggle -->
        <div id="admin-toggle-container" class="text-center mb-4">
            <button id="admin-toggle" class="text-sm text-primary underline">Admin Controls</button>
        </div>
        
        <!-- Password Modal -->
        <div id="password-modal" class="max-w-sm mx-auto mb-4 p-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg hidden">
            <h3 class="text-lg font-bold mb-3">Enter Admin Password</h3>
            <div class="mb-4">
                <input type="password" id="admin-password" class="w-full p-2 border rounded bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-700" placeholder="Password" />
            </div>
            <div class="flex justify-between">
                <button id="cancel-password" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded">Cancel</button>
                <button id="submit-password" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded">Submit</button>
            </div>
            <p id="password-error" class="mt-2 text-red-500 text-sm hidden">Incorrect password. Please try again.</p>
            <div class="mt-3 text-sm">
                <label class="flex items-center">
                    <input type="checkbox" id="set-password" class="mr-2">
                    Set a new password
                </label>
                <div id="new-password-container" class="mt-2 hidden">
                    <input type="password" id="new-password" class="w-full p-2 border rounded bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-700 mb-2" placeholder="New Password" />
                    <input type="password" id="confirm-password" class="w-full p-2 border rounded bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-700" placeholder="Confirm Password" />
                    <p id="password-mismatch" class="mt-1 text-red-500 text-xs hidden">Passwords don't match</p>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div id="admin-panel" class="max-w-2xl mx-auto mb-8 p-4 border border-gray-300 dark:border-gray-700 rounded-lg hidden">
            <h2 class="text-xl font-bold mb-4">Admin Panel - Import Data</h2>
            
            <div class="mb-6">
                <h3 class="font-medium mb-2">1. Upload Logo</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Upload a logo image (PNG or JPEG, max 2MB)</p>
                <div class="flex items-center gap-2">
                    <input type="file" id="logo-image" accept="image/png,image/jpeg,image/jpg" class="block w-full text-sm text-gray-900 dark:text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90 cursor-pointer" />
                    <button id="remove-logo" class="text-sm text-red-500 hover:text-red-600">Remove Logo</button>
                </div>
                <div id="logo-preview" class="mt-3 flex justify-center items-center p-3 bg-gray-100 dark:bg-gray-800 rounded-lg hidden">
                    <img id="logo-preview-image" src="" alt="Logo Preview" class="max-h-20 max-w-full" />
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-medium mb-2">2. Import Attendees CSV</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">CSV format: id,name (e.g., "1,John Smith")</p>
                <div class="flex items-center gap-2">
                    <input type="file" id="attendees-csv" accept=".csv" class="block w-full text-sm text-gray-900 dark:text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90 cursor-pointer" />
                    <button id="download-attendee-template" class="text-sm text-primary">Get Template</button>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-medium mb-2">3. Import Meetings CSV</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">CSV format: id,title,start,end,location,participants (e.g., "m1,Meeting Title,2023-06-01T09:00:00,2023-06-01T10:00:00,Room A,1,2,3,4")</p>
                <div class="flex items-center gap-2">
                    <input type="file" id="meetings-csv" accept=".csv" class="block w-full text-sm text-gray-900 dark:text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90 cursor-pointer" />
                    <button id="download-meeting-template" class="text-sm text-primary">Get Template</button>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-medium">Data Preview</h3>
                    <div class="flex gap-2">
                        <button id="toggle-attendees-preview" class="text-xs px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded">Attendees</button>
                        <button id="toggle-meetings-preview" class="text-xs px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded">Meetings</button>
                    </div>
                </div>
                <div id="data-preview" class="mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg max-h-40 overflow-y-auto text-xs">
                    <p class="text-center text-gray-500">Import data to see preview</p>
                </div>
            </div>
            
            <div class="text-center">
                <button id="close-admin" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded">Close Admin Panel</button>
            </div>
        </div>
        
        <!-- Main app sections -->
        <div id="welcome-screen" class="mb-8">
            <p class="text-center mb-4">Welcome!<br>Select your name to view your personalized schedule,<br>or scan your QR code.</p>
            
            <div class="max-w-md mx-auto">
                <!-- Role Filter Dropdown -->
                <div class="mb-4">
                    <label for="role-filter" class="block mb-2 font-medium">Filter by role:</label>
                    <select id="role-filter" class="w-full p-3 border rounded bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-700 focus:ring-primary focus:border-primary text-base">
                        <option value="all">All Attendees</option>
                        <option value="participant">Participants</option>
                        <option value="observer-roleplayer">Observers & Role Players</option>
                    </select>
                </div>
                
                <label for="attendee-select" class="block mb-2 font-medium">Select your name:</label>
                <select id="attendee-select" class="w-full p-3 border rounded bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-700 focus:ring-primary focus:border-primary text-base">
                    <option value="">-- Select your name --</option>
                    <!-- Will be populated with JavaScript -->
                </select>
                <button id="view-agenda-btn" class="mt-4 w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 px-4 rounded transition">
                    View My Agenda
                </button>
                <p id="error-message" class="mt-2 text-red-500 text-center hidden"></p>
            </div>
            
            <div class="mt-8 text-center">
                <p class="mb-4">To generate your personal QR code:</p>
                <div class="flex justify-center">
                    <div id="qr-container" class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md"></div>
                </div>
                <p class="mt-4 text-sm text-gray-600 dark:text-gray-400">Scan this code to view your agenda on another device</p>
            </div>
        </div>
        
        <div id="personal-agenda" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button id="back-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded transition">
                    Back
                </button>
                <h2 id="attendee-name" class="text-xl font-bold text-primary"></h2>
            </div>
            
            <div id="agenda-container" class="space-y-4">
                <!-- Will be populated with JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Generate today's date for our sample data
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
        
        // Sample data - this would come from a server in a real application
        let attendees = [
            { id: "1", name: "John Smith", role: "participant" },
            { id: "2", name: "Jane Doe", role: "participant" },
            { id: "3", name: "Michael Johnson", role: "observer" },
            { id: "4", name: "Sarah Williams", role: "observer,roleplayer" },
            { id: "5", name: "Robert Brown", role: "participant" },
            { id: "6", name: "Emily Davis", role: "roleplayer" },
            { id: "7", name: "David Wilson", role: "participant" },
            { id: "8", name: "Lisa Martinez", role: "observer" },
            { id: "9", name: "James Taylor", role: "participant" },
            { id: "10", name: "Patricia Anderson", role: "observer,roleplayer" },
            // In a real app, there would be around 50 people as specified
        ];
        
        let meetings = [
            {
                id: "m1",
                title: "Product Strategy",
                start: `${dateStr}T08:30:00`,
                end: `${dateStr}T09:30:00`,
                location: "Room A",
                participants: ["1", "2", "3", "4"]
            },
            {
                id: "m2",
                title: "Design Review",
                start: `${dateStr}T09:45:00`,
                end: `${dateStr}T10:30:00`,
                location: "Room B",
                participants: ["1", "5", "6", "7"]
            },
            {
                id: "m3",
                title: "Client Presentation",
                start: `${dateStr}T10:45:00`,
                end: `${dateStr}T11:45:00`,
                location: "Conference Hall",
                participants: ["2", "3", "8", "9"]
            },
            {
                id: "m4",
                title: "Team Lunch",
                start: `${dateStr}T12:00:00`,
                end: `${dateStr}T13:00:00`,
                location: "Cafeteria",
                participants: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"]
            },
            {
                id: "m5",
                title: "Technical Discussion",
                start: `${dateStr}T13:15:00`,
                end: `${dateStr}T14:15:00`,
                location: "Room C",
                participants: ["1", "3", "5", "10"]
            },
            {
                id: "m6",
                title: "Project Planning",
                start: `${dateStr}T14:30:00`,
                end: `${dateStr}T15:30:00`,
                location: "Room A",
                participants: ["2", "4", "6", "8"]
            },
            {
                id: "m7",
                title: "Budget Review",
                start: `${dateStr}T15:45:00`,
                end: `${dateStr}T16:15:00`,
                location: "Room D",
                participants: ["1", "5", "9"]
            },
            {
                id: "m8",
                title: "Marketing Strategy",
                start: `${dateStr}T16:30:00`,
                end: `${dateStr}T17:30:00`,
                location: "Room B",
                participants: ["2", "7", "10"]
            },
            // In a real app, there would be more meetings based on the complex matrix
        ];
        
        // DOM elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const personalAgenda = document.getElementById('personal-agenda');
        const attendeeSelect = document.getElementById('attendee-select');
        const viewAgendaBtn = document.getElementById('view-agenda-btn');
        const backBtn = document.getElementById('back-btn');
        const attendeeNameDisplay = document.getElementById('attendee-name');
        const agendaContainer = document.getElementById('agenda-container');
        const qrContainer = document.getElementById('qr-container');
        const errorMessage = document.getElementById('error-message');
        
        // Admin panel elements
        const adminToggle = document.getElementById('admin-toggle');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdmin = document.getElementById('close-admin');
        const attendeesCsvInput = document.getElementById('attendees-csv');
        const meetingsCsvInput = document.getElementById('meetings-csv');
        const downloadAttendeeTemplate = document.getElementById('download-attendee-template');
        const downloadMeetingTemplate = document.getElementById('download-meeting-template');
        const dataPreview = document.getElementById('data-preview');
        const toggleAttendeesPreview = document.getElementById('toggle-attendees-preview');
        const toggleMeetingsPreview = document.getElementById('toggle-meetings-preview');
        
        // Role filter dropdown element
        const roleFilter = document.getElementById('role-filter');
        
        // Populate the attendee dropdown based on role filter selection
        function populateAttendeeDropdown() {
            // Clear existing options except the default one
            while (attendeeSelect.options.length > 1) {
                attendeeSelect.remove(1);
            }
            
            // Get selected filter value
            const filterValue = roleFilter.value;
            console.log(`Filtering by role: ${filterValue}`);
            
            // Filter attendees based on selected role
            let filteredAttendees;
            
            if (filterValue === 'all') {
                // Show all attendees
                filteredAttendees = [...attendees];
                console.log("Showing all attendees, total:", attendees.length);
            } else if (filterValue === 'participant') {
                // Show only participants
                filteredAttendees = attendees.filter(attendee => {
                    const roleLower = (attendee.role || "").toLowerCase();
                    const roles = roleLower.split(/[,;]+/).map(r => r.trim());
                    
                    return roles.includes('participant') || 
                           roles.includes('participants') || 
                           roleLower.includes('part');
                });
                console.log("Showing participants, count:", filteredAttendees.length);
            } else if (filterValue === 'observer-roleplayer') {
                // Show only observers and role players
                filteredAttendees = attendees.filter(attendee => {
                    const roleLower = (attendee.role || "").toLowerCase();
                    const roles = roleLower.split(/[,;]+/).map(r => r.trim());
                    
                    return roles.includes('observer') || 
                           roles.includes('observers') || 
                           roles.includes('roleplayer') || 
                           roles.includes('roleplayers') || 
                           roles.includes('role player') || 
                           roles.includes('role players') || 
                           roleLower.includes('observ') || 
                           roleLower.includes('role');
                });
                console.log("Showing observers/roleplayers, count:", filteredAttendees.length);
            }
            
            // Sort by name
            filteredAttendees.sort((a, b) => a.name.localeCompare(b.name));
            
            // Add attendees to dropdown
            filteredAttendees.forEach(attendee => {
                const option = document.createElement('option');
                option.value = attendee.id;
                option.textContent = attendee.name;
                attendeeSelect.appendChild(option);
            });
            
            // Show message if no attendees found with selected filter
            if (filteredAttendees.length === 0) {
                attendeeSelect.innerHTML = '<option value="">No attendees found with selected role</option>';
            }
            
            // Clear any previous error messages
            errorMessage.classList.add('hidden');
            
            // Clear QR code
            qrContainer.innerHTML = '<p class="text-gray-500">Select an attendee to generate QR code</p>';
        }
        
        // Role filter change event handler
        roleFilter.addEventListener('change', populateAttendeeDropdown);
        
        // Initialize dropdown with all attendees
        populateAttendeeDropdown();
        
        // Event listeners
        attendeeSelect.addEventListener('change', updateQRCode);
        viewAgendaBtn.addEventListener('click', showPersonalAgenda);
        backBtn.addEventListener('click', showWelcomeScreen);
        
        // Logo elements
        const logoContainer = document.getElementById('logo-container');
        const appLogo = document.getElementById('app-logo');
        const logoImageInput = document.getElementById('logo-image');
        const removeLogoBtn = document.getElementById('remove-logo');
        const logoPreview = document.getElementById('logo-preview');
        const logoPreviewImage = document.getElementById('logo-preview-image');
        
        // Logo handling functions
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Logo file is too large. Maximum size is 2MB.');
                logoImageInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const logoData = e.target.result;
                
                // Show logo preview
                logoPreviewImage.src = logoData;
                logoPreview.classList.remove('hidden');
                
                // Store logo in localStorage for persistence
                try {
                    localStorage.setItem('appLogo', logoData);
                } catch (e) {
                    console.log('Could not save logo to localStorage:', e);
                }
                
                // Show logo in app
                appLogo.src = logoData;
                logoContainer.classList.remove('hidden');
            };
            
            reader.readAsDataURL(file);
        }
        
        function handleRemoveLogo() {
            // Clear file input
            logoImageInput.value = '';
            
            // Hide preview
            logoPreviewImage.src = '';
            logoPreview.classList.add('hidden');
            
            // Remove from localStorage
            try {
                localStorage.removeItem('appLogo');
            } catch (e) {
                console.log('Could not remove logo from localStorage:', e);
            }
            
            // Hide logo in app
            appLogo.src = '';
            logoContainer.classList.add('hidden');
        }
        
        // Load saved logo on page load
        function loadSavedLogo() {
            try {
                const savedLogo = localStorage.getItem('appLogo');
                if (savedLogo) {
                    // Show logo in app
                    appLogo.src = savedLogo;
                    logoContainer.classList.remove('hidden');
                    
                    // Show in preview
                    logoPreviewImage.src = savedLogo;
                    logoPreview.classList.remove('hidden');
                }
            } catch (e) {
                console.log('Could not load logo from localStorage:', e);
            }
        }
        
        // Logo event listeners
        logoImageInput.addEventListener('change', handleLogoUpload);
        removeLogoBtn.addEventListener('click', handleRemoveLogo);
        
        // Load saved logo on page load
        loadSavedLogo();
        
        // Password elements
        const passwordModal = document.getElementById('password-modal');
        const adminPassword = document.getElementById('admin-password');
        const submitPassword = document.getElementById('submit-password');
        const cancelPassword = document.getElementById('cancel-password');
        const passwordError = document.getElementById('password-error');
        const setPasswordCheckbox = document.getElementById('set-password');
        const newPasswordContainer = document.getElementById('new-password-container');
        const newPassword = document.getElementById('new-password');
        const confirmPassword = document.getElementById('confirm-password');
        const passwordMismatch = document.getElementById('password-mismatch');
        
        // Default password (if none is set)
        const DEFAULT_PASSWORD = "admin123";
        
        // Password handling functions
        function showPasswordModal() {
            // Reset password fields
            adminPassword.value = '';
            newPassword.value = '';
            confirmPassword.value = '';
            setPasswordCheckbox.checked = false;
            newPasswordContainer.classList.add('hidden');
            passwordError.classList.add('hidden');
            passwordMismatch.classList.add('hidden');
            
            // Show modal
            passwordModal.classList.remove('hidden');
            adminPassword.focus();
        }
        
        function hidePasswordModal() {
            passwordModal.classList.add('hidden');
        }
        
        function validatePassword() {
            const enteredPassword = adminPassword.value;
            
            // Get stored password or use default
            let correctPassword;
            try {
                correctPassword = localStorage.getItem('adminPassword') || DEFAULT_PASSWORD;
            } catch (e) {
                correctPassword = DEFAULT_PASSWORD;
            }
            
            // Check if setting a new password
            if (setPasswordCheckbox.checked) {
                const newPasswordValue = newPassword.value;
                const confirmedPassword = confirmPassword.value;
                
                // Check if passwords match
                if (newPasswordValue !== confirmedPassword) {
                    passwordMismatch.classList.remove('hidden');
                    return false;
                }
                
                // Save new password if entered
                if (newPasswordValue) {
                    try {
                        localStorage.setItem('adminPassword', newPasswordValue);
                    } catch (e) {
                        console.log('Could not save password to localStorage:', e);
                    }
                }
            }
            
            // Validate current password
            return enteredPassword === correctPassword;
        }
        
        // Admin panel event listeners
        adminToggle.addEventListener('click', () => {
            // Show password modal first
            showPasswordModal();
        });
        
        // Password event listeners
        submitPassword.addEventListener('click', () => {
            if (validatePassword()) {
                hidePasswordModal();
                adminPanel.classList.remove('hidden');
            } else {
                if (!setPasswordCheckbox.checked || !passwordMismatch.classList.contains('hidden')) {
                    passwordError.classList.remove('hidden');
                    adminPassword.focus();
                }
            }
        });
        
        cancelPassword.addEventListener('click', () => {
            hidePasswordModal();
        });
        
        setPasswordCheckbox.addEventListener('change', () => {
            if (setPasswordCheckbox.checked) {
                newPasswordContainer.classList.remove('hidden');
                newPassword.focus();
            } else {
                newPasswordContainer.classList.add('hidden');
            }
        });
        
        // Allow Enter key to submit password
        adminPassword.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                submitPassword.click();
            }
        });
        
        // Admin panel close button
        closeAdmin.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
        });
        
        attendeesCsvInput.addEventListener('change', handleAttendeesCsvUpload);
        meetingsCsvInput.addEventListener('change', handleMeetingsCsvUpload);
        
        downloadAttendeeTemplate.addEventListener('click', downloadAttendeesCsvTemplate);
        downloadMeetingTemplate.addEventListener('click', downloadMeetingsCsvTemplate);
        
        toggleAttendeesPreview.addEventListener('click', () => showDataPreview('attendees'));
        toggleMeetingsPreview.addEventListener('click', () => showDataPreview('meetings'));
        
        // Admin secret access - keyboard shortcut (Ctrl+Shift+A)
        const adminToggleContainer = document.getElementById('admin-toggle-container');
        
        document.addEventListener('keydown', function(event) {
            // Check for Ctrl+Shift+A keyboard shortcut
            if (event.ctrlKey && event.shiftKey && event.key === 'A') {
                // Toggle admin panel visibility
                adminToggleContainer.classList.toggle('hidden');
                
                // If showing, focus the admin toggle button
                if (!adminToggleContainer.classList.contains('hidden')) {
                    adminToggle.focus();
                }
            }
        });
        
        // Check for admin mode in URL
        function checkAdminMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            
            if (isAdmin) {
                adminToggleContainer.classList.remove('hidden');
            }
        }
        
        // Check if URL has an attendee parameter
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const attendeeId = urlParams.get('attendee');
            
            // Check for admin mode
            checkAdminMode();
            
            if (attendeeId) {
                // Check if it's a valid attendee ID
                const attendeeExists = attendees.some(a => a.id === attendeeId);
                
                if (attendeeExists) {
                    // Set the dropdown to the selected attendee
                    attendeeSelect.value = attendeeId;
                    // Update QR code
                    updateQRCode();
                    // Show their agenda
                    showPersonalAgenda();
                }
            }
        });
        
        function updateQRCode() {
            const selectedAttendeeId = attendeeSelect.value;
            
            if (selectedAttendeeId) {
                // Clear previous QR code
                qrContainer.innerHTML = '';
                
                // Generate URL for the selected attendee
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('attendee', selectedAttendeeId);
                
                // Generate QR code
                new QRCode(qrContainer, {
                    text: currentUrl.toString(),
                    width: 128,
                    height: 128,
                    colorDark: "#5D5CDE",
                    colorLight: document.documentElement.classList.contains('dark') ? "#2D3748" : "#FFFFFF",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } else {
                qrContainer.innerHTML = '<p class="text-gray-500">Select an attendee to generate QR code</p>';
            }
        }
        
        function showPersonalAgenda() {
            const selectedAttendeeId = attendeeSelect.value;
            
            if (!selectedAttendeeId) {
                errorMessage.textContent = 'Please select an attendee';
                errorMessage.classList.remove('hidden');
                return;
            }
            
            errorMessage.classList.add('hidden');
            
            const selectedAttendee = attendees.find(a => a.id === selectedAttendeeId);
            
            // Create role badges for the attendee
            let roleBadges = '';
            if (selectedAttendee.role) {
                roleBadges = selectedAttendee.role.split(',').map(role => {
                    let badgeClass = "";
                    switch(role.trim()) {
                        case "participant":
                            badgeClass = "bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200";
                            break;
                        case "observer":
                            badgeClass = "bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200";
                            break;
                        case "roleplayer":
                            badgeClass = "bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200";
                            break;
                        default:
                            badgeClass = "bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200";
                    }
                    return `<span class="inline-block px-2 py-0.5 rounded-full text-xs ${badgeClass} ml-2">${role.trim()}</span>`;
                }).join('');
            }
            
            // Show name and role badges
            attendeeNameDisplay.innerHTML = `${selectedAttendee.name}'s Agenda ${roleBadges}`;
            
            // Filter meetings for the selected attendee
            const attendeeMeetings = meetings.filter(meeting => 
                meeting.participants.includes(selectedAttendeeId)
            ).sort((a, b) => new Date(a.start) - new Date(b.start));
            
            // Clear previous agenda
            agendaContainer.innerHTML = '';
            
            // Display meetings
            if (attendeeMeetings.length === 0) {
                agendaContainer.innerHTML = '<p class="text-center py-4">No meetings scheduled for this attendee.</p>';
            } else {
                attendeeMeetings.forEach(meeting => {
                    const startTime = new Date(meeting.start);
                    const endTime = new Date(meeting.end);
                    const durationMs = endTime - startTime;
                    const durationMinutes = Math.round(durationMs / 60000);
                    
                    // Get other participants' names and roles
                    const otherParticipants = meeting.participants
                        .filter(id => id !== selectedAttendeeId)
                        .map(id => {
                            const attendee = attendees.find(a => a.id === id);
                            return attendee || { id, name: 'Unknown', role: '' };
                        });
                    
                    const meetingElement = document.createElement('div');
                    meetingElement.className = 'p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md border-l-4 border-primary';
                    meetingElement.innerHTML = `
                        <div class="flex flex-wrap justify-between items-start gap-2">
                            <h3 class="font-bold text-lg">${meeting.title}</h3>
                            <span class="bg-primary/10 text-primary px-2 py-1 rounded text-sm whitespace-nowrap">${durationMinutes} min</span>
                        </div>
                        <div class="mt-2 text-gray-600 dark:text-gray-400">
                            <p class="flex items-center">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-medium">${startTime.toLocaleDateString()}</span>
                                <span class="mx-2">â€¢</span>
                                <span class="whitespace-nowrap">${startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - 
                                ${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </p>
                            <p class="flex items-center mt-1">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                ${meeting.location}
                            </p>
                            <div class="mt-3">
                                <p class="text-sm font-medium mb-1">Meeting with:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${(() => {
                                        // Check if this meeting includes exactly all attendees
                                        const meetingParticipantCount = meeting.participants.length;
                                        const totalAttendeeCount = attendees.length;
                                        
                                        // Only show "All participants" if exactly 100% of attendees are included
                                        if (meetingParticipantCount === totalAttendeeCount) {
                                            return `<span class="bg-primary/10 text-primary px-3 py-1 rounded-full text-xs font-medium">
                                                All participants (${meetingParticipantCount} people)
                                            </span>`;
                                        }
                                        
                                        // If meeting has more than 15 other participants, summarize by roles
                                        else if (otherParticipants.length > 15) {
                                            // Count by role
                                            const roleCounts = {
                                                participant: 0,
                                                observer: 0,
                                                roleplayer: 0
                                            };
                                            
                                            otherParticipants.forEach(attendee => {
                                                if (!attendee.role) {
                                                    roleCounts.participant++;
                                                    return;
                                                }
                                                
                                                const roles = attendee.role.split(',').map(r => r.trim());
                                                if (roles.includes('participant')) roleCounts.participant++;
                                                if (roles.includes('observer')) roleCounts.observer++;
                                                if (roles.includes('roleplayer')) roleCounts.roleplayer++;
                                            });
                                            
                                            // Create summary badges
                                            let badges = '';
                                            if (roleCounts.participant > 0) {
                                                badges += `<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-xs font-medium">
                                                    ${roleCounts.participant} Participants
                                                </span>`;
                                            }
                                            if (roleCounts.observer > 0) {
                                                badges += `<span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-xs font-medium">
                                                    ${roleCounts.observer} Observers
                                                </span>`;
                                            }
                                            if (roleCounts.roleplayer > 0) {
                                                badges += `<span class="bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-3 py-1 rounded-full text-xs font-medium">
                                                    ${roleCounts.roleplayer} Role Players
                                                </span>`;
                                            }
                                            
                                            return badges;
                                        }
                                        
                                        // Otherwise, show individual participants grouped by role
                                        else {
                                            // Separate attendees by role
                                            const participants = [];
                                            const observers = [];
                                            const rolePlayers = [];
                                            const others = [];
                                            
                                            otherParticipants.forEach(attendee => {
                                                // Set badge color based on role
                                                let badgeClass = "bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200";
                                                let roleType = "other";
                                                
                                                if (attendee.role) {
                                                    const roleLower = attendee.role.toLowerCase();
                                                    const roles = roleLower.split(/[,;]+/).map(r => r.trim());
                                                    
                                                    // Determine primary role for sorting
                                                    if (roles.includes('participant') || roleLower.includes('part')) {
                                                        badgeClass = "bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200";
                                                        roleType = "participant";
                                                    } else if (roles.includes('observer') || roleLower.includes('observ')) {
                                                        badgeClass = "bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200";
                                                        roleType = "observer";
                                                    } else if (roles.includes('roleplayer') || roles.includes('role player') || 
                                                              roleLower.includes('role')) {
                                                        badgeClass = "bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200";
                                                        roleType = "roleplayer";
                                                    }
                                                } else {
                                                    // Default to participant if no role specified
                                                    badgeClass = "bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200";
                                                    roleType = "participant";
                                                }
                                                
                                                const attendeeHtml = `<span class="${badgeClass} px-2 py-1 rounded-full text-xs flex items-center">
                                                    ${attendee.name}
                                                </span>`;
                                                
                                                // Add to appropriate group
                                                if (roleType === "participant") {
                                                    participants.push(attendeeHtml);
                                                } else if (roleType === "observer") {
                                                    observers.push(attendeeHtml);
                                                } else if (roleType === "roleplayer") {
                                                    rolePlayers.push(attendeeHtml);
                                                } else {
                                                    others.push(attendeeHtml);
                                                }
                                            });
                                            
                                            // Construct the HTML with role groups on separate lines
                                            let html = '';
                                            
                                            // Participants first (if any)
                                            if (participants.length > 0) {
                                                html += `<div class="mb-3">
                                                    <div class="font-medium text-xs text-gray-500 mb-1">Participants:</div>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${participants.join('')}
                                                    </div>
                                                </div>`;
                                            }
                                            
                                            // Observers second (if any)
                                            if (observers.length > 0) {
                                                html += `<div class="mb-3">
                                                    <div class="font-medium text-xs text-gray-500 mb-1">Observers:</div>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${observers.join('')}
                                                    </div>
                                                </div>`;
                                            }
                                            
                                            // Role players third (if any)
                                            if (rolePlayers.length > 0) {
                                                html += `<div class="flex flex-wrap gap-2 mb-2">
                                                    ${rolePlayers.join('')}
                                                </div>`;
                                            }
                                            
                                            // Others last (if any)
                                            if (others.length > 0) {
                                                html += `<div class="flex flex-wrap gap-2">
                                                    ${others.join('')}
                                                </div>`;
                                            }
                                            
                                            return html;
                                        }
                                    })()}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    agendaContainer.appendChild(meetingElement);
                });
            }
            
            // Show agenda screen, hide welcome screen
            welcomeScreen.classList.add('hidden');
            personalAgenda.classList.remove('hidden');
        }
        
        function showWelcomeScreen() {
            personalAgenda.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
        }
        
        // Initialize QR code display
        updateQRCode();
        
        // CSV Import Functions
        
        // Handle attendees CSV upload
        function handleAttendeesCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        const newAttendees = [];
                        
                        // Process each row
                        results.data.forEach((row, index) => {
                            // Skip header row if present
                            if (index === 0 && row[0].toLowerCase() === 'id') return;
                            
                            if (row.length >= 2) {
                                // Add attendee with basic info
                                const attendee = {
                                    id: row[0].toString(),
                                    name: row[1]
                                };
                                
                                // Check if role column exists (3rd column)
                                if (row.length >= 3 && row[2]) {
                                    // Store the role, normalizing to lowercase
                                    attendee.role = row[2].toLowerCase();
                                } else {
                                    // Default role
                                    attendee.role = "participant";
                                }
                                
                                // Log the attendee for debugging
                                console.log("Imported attendee:", attendee);
                                
                                newAttendees.push(attendee);
                            }
                        });
                        
                        if (newAttendees.length > 0) {
                            attendees = newAttendees;
                            populateAttendeeDropdown();
                            showDataPreview('attendees');
                            
                            // Show success message
                            dataPreview.innerHTML = `<p class="text-green-500">âœ“ Successfully imported ${attendees.length} attendees.</p>` + 
                                                   dataPreview.innerHTML;
                        } else {
                            throw new Error("No valid attendees found in CSV");
                        }
                    } catch (error) {
                        dataPreview.innerHTML = `<p class="text-red-500">Error importing attendees: ${error.message}</p>`;
                    }
                },
                error: function(error) {
                    dataPreview.innerHTML = `<p class="text-red-500">Error parsing CSV: ${error.message}</p>`;
                }
            });
        }
        
        // Handle meetings CSV upload
        function handleMeetingsCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        const newMeetings = [];
                        
                        // Process each row
                        results.data.forEach((row, index) => {
                            // Skip header row if present
                            if (index === 0 && row[0].toLowerCase() === 'id') return;
                            
                            if (row.length >= 6) {
                                // Extract the first 5 columns as basic meeting info
                                const meetingInfo = {
                                    id: row[0].toString(),
                                    title: row[1],
                                    start: row[2],
                                    end: row[3],
                                    location: row[4],
                                    participants: []
                                };
                                
                                // All remaining columns are participant IDs
                                for (let i = 5; i < row.length; i++) {
                                    if (row[i] && row[i].trim() !== '') {
                                        meetingInfo.participants.push(row[i].toString());
                                    }
                                }
                                
                                newMeetings.push(meetingInfo);
                            }
                        });
                        
                        if (newMeetings.length > 0) {
                            meetings = newMeetings;
                            showDataPreview('meetings');
                            
                            // Show success message
                            dataPreview.innerHTML = `<p class="text-green-500">âœ“ Successfully imported ${meetings.length} meetings.</p>` + 
                                                   dataPreview.innerHTML;
                        } else {
                            throw new Error("No valid meetings found in CSV");
                        }
                    } catch (error) {
                        dataPreview.innerHTML = `<p class="text-red-500">Error importing meetings: ${error.message}</p>`;
                    }
                },
                error: function(error) {
                    dataPreview.innerHTML = `<p class="text-red-500">Error parsing CSV: ${error.message}</p>`;
                }
            });
        }
        
        // Generate CSV content
        function generateCsv(data) {
            return data.map(row => row.map(value => {
                // Quote strings with commas
                if (typeof value === 'string' && value.includes(',')) {
                    return `"${value}"`;
                }
                return value;
            }).join(',')).join('\n');
        }
        
        // Download attendees CSV template
        function downloadAttendeesCsvTemplate() {
            // Create sample data with roles
            const csvData = [
                ['id', 'name', 'role'],
                ['1', 'John Smith', 'participant'],
                ['2', 'Jane Doe', 'participant'],
                ['3', 'Michael Johnson', 'observer'],
                ['4', 'Sarah Williams', 'observer,roleplayer'],
                ['5', 'Robert Brown', 'roleplayer']
            ];
            
            const csvContent = generateCsv(csvData);
            downloadCsv(csvContent, 'attendees_template.csv');
        }
        
        // Download meetings CSV template
        function downloadMeetingsCsvTemplate() {
            // Create sample data with ISO format dates
            const dateStr = new Date().toISOString().split('T')[0];
            const csvData = [
                ['id', 'title', 'start', 'end', 'location', 'participant1', 'participant2', 'participant3', 'participant4'],
                ['m1', 'Product Strategy', `${dateStr}T09:00:00`, `${dateStr}T10:00:00`, 'Room A', '1', '2', '3', '4'],
                ['m2', 'Design Review', `${dateStr}T10:30:00`, `${dateStr}T11:30:00`, 'Room B', '1', '5', '6', '7']
            ];
            
            const csvContent = generateCsv(csvData);
            downloadCsv(csvContent, 'meetings_template.csv');
        }
        
        // Generic function to trigger CSV download
        function downloadCsv(csvContent, filename) {
            // Create a blob with the CSV data
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Create a temporary link element
            const link = document.createElement('a');
            
            // Set link attributes
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // Add to the DOM
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            
            // Clean up
            document.body.removeChild(link);
        }
        
        // Show data preview 
        function showDataPreview(dataType) {
            if (dataType === 'attendees') {
                if (attendees.length === 0) {
                    dataPreview.innerHTML = '<p class="text-center text-gray-500">No attendee data available</p>';
                    return;
                }
                
                let html = '<div class="font-medium mb-1">Attendees Preview:</div>';
                html += '<table class="w-full border-collapse">';
                html += '<thead><tr><th class="text-left pr-4">ID</th><th class="text-left pr-4">Name</th><th class="text-left">Role</th></tr></thead>';
                html += '<tbody>';
                
                // Show up to 10 attendees in preview
                const previewAttendees = attendees.slice(0, 10);
                previewAttendees.forEach(attendee => {
                    // Format role display
                    const roleDisplay = attendee.role || "participant";
                    
                    // Convert roles into badge colors
                    const roleBadges = roleDisplay.split(',').map(role => {
                        let badgeClass = "";
                        switch(role.trim()) {
                            case "participant":
                                badgeClass = "bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200";
                                break;
                            case "observer":
                                badgeClass = "bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200";
                                break;
                            case "roleplayer":
                                badgeClass = "bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200";
                                break;
                            default:
                                badgeClass = "bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200";
                        }
                        return `<span class="inline-block px-2 py-0.5 rounded-full text-xs ${badgeClass}">${role.trim()}</span>`;
                    }).join(' ');
                    
                    html += `<tr>
                        <td class="pr-4">${attendee.id}</td>
                        <td class="pr-4">${attendee.name}</td>
                        <td>${roleBadges}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                
                if (attendees.length > 10) {
                    html += `<p class="text-gray-500 mt-1">...and ${attendees.length - 10} more attendees</p>`;
                }
                
                dataPreview.innerHTML = html;
            } else if (dataType === 'meetings') {
                if (meetings.length === 0) {
                    dataPreview.innerHTML = '<p class="text-center text-gray-500">No meeting data available</p>';
                    return;
                }
                
                let html = '<div class="font-medium mb-1">Meetings Preview:</div>';
                html += '<table class="w-full border-collapse">';
                html += '<thead><tr><th class="text-left pr-2">ID</th><th class="text-left pr-2">Title</th><th class="text-left pr-2">Time</th><th class="text-left">Participants</th></tr></thead>';
                html += '<tbody>';
                
                // Show up to 5 meetings in preview
                const previewMeetings = meetings.slice(0, 5);
                previewMeetings.forEach(meeting => {
                    const startTime = new Date(meeting.start);
                    const endTime = new Date(meeting.end);
                    const timeStr = `${startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    
                    html += `<tr>
                        <td class="pr-2">${meeting.id}</td>
                        <td class="pr-2">${meeting.title}</td>
                        <td class="pr-2">${timeStr}</td>
                        <td>${meeting.participants.length} people</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                
                if (meetings.length > 5) {
                    html += `<p class="text-gray-500 mt-1">...and ${meetings.length - 5} more meetings</p>`;
                }
                
                dataPreview.innerHTML = html;
            }
        }
    </script>
</body>
</html>
